<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ö–æ—Ä–∑–∏–Ω–∞</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <script src="script.js"></script>
  </head>
  <body data-page="cart">
    <header>
      <nav>
        <a href="/">–ì–ª–∞–≤–Ω–∞—è</a>
        <a href="/price.html">–ü—Ä–∞–π—Å</a>
        <div id="auth-links" hx-get="/api/auth/me" hx-trigger="load"></div>
        <a href="/cart.html">–ö–æ—Ä–∑–∏–Ω–∞</a>
      </nav>
    </header>
    <main>
      <div id="cart-container">
        <div id="cart">
          <h2>üõí –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</h2>
          <div
            id="cart-items"
            hx-get="/api/cart/items"
            hx-trigger="load, cart-updated from:body"
            hx-swap="innerHTML"
          ></div>
        </div>

        <div class="date-picker">
          <h2>üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—ã –∞—Ä–µ–Ω–¥—ã</h2>
          <label for="start-date">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</label>
          <input type="date" id="start-date" name="start-date" required />

          <label for="end-date">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label>
          <input type="date" id="end-date" name="end-date" required />

          <div class="payment-method">
            <h3>üí≥ –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</h3>
            <div class="payment-options">
              <label class="payment-option">
                <input type="radio" name="payment" value="card" checked />
                <span>üí≥ –ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</span>
              </label>
              <label class="payment-option">
                <input type="radio" name="payment" value="cash" />
                <span>üíµ –ù–∞–ª–∏—á–Ω—ã–µ</span>
              </label>
            </div>
          </div>

          <div class="cart-buttons">
            <button
              id="clear-cart-button"
              hx-post="/api/cart/clear"
              hx-swap="none"
              hx-trigger="click"
              hx-on::after-request="
                document.body.dispatchEvent(new Event('cart-updated'));
                document.getElementById('start-date').value = '';
                document.getElementById('end-date').value = '';
              "
            >
              –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É
            </button>

            <button
              id="checkout-button"
              hx-post="/api/orders"
              hx-include="[name='start-date'], [name='end-date'], [name='payment']"
              hx-swap="none"
              hx-on::before-request="
                const cartItems = document.querySelectorAll('.cart-item');
                if (cartItems.length === 0) {
                  showNotification('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞', 'error');
                  event.preventDefault();
                  return false;
                }
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                if (!startDate || !endDate) {
                  showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—ã –∞—Ä–µ–Ω–¥—ã', 'error');
                  event.preventDefault();
                  return false;
                }
              "
            >
              –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
            </button>
          </div>
        </div>
      </div>
    </main>

    <div id="notifications-container"></div>

    <script>
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      document.addEventListener("DOMContentLoaded", function () {
        fetch("/api/auth/me")
          .then((response) => response.text())
          .then((html) => {
            if (html.includes("–í–æ–π—Ç–∏")) {
              window.location.href = "/login.html";
            }
          });
      });

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
      document.body.addEventListener("htmx:afterRequest", function (evt) {
        if (evt.detail.path === "/api/orders") {
          if (evt.detail.successful) {
            const notification = document.createElement("div");
            notification.className = "notification success";
            notification.textContent = "‚úÖ –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω!";
            document
              .getElementById("notifications-container")
              .appendChild(notification);
            setTimeout(() => {
              notification.remove();
              window.location.href = "/profile.html";
            }, 2000);
          } else if (evt.detail.xhr.status === 401) {
            window.location.href = "/login.html";
          } else {
            const notification = document.createElement("div");
            notification.className = "notification error";
            notification.textContent = "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞";
            document
              .getElementById("notifications-container")
              .appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
          }
        }
      });

      function validateDates() {
        const startDate = document.getElementById("start-date").value;
        const endDate = document.getElementById("end-date").value;

        if (startDate && endDate) {
          if (new Date(startDate) > new Date(endDate)) {
            alert("–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–∑–∂–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è");
            document.getElementById("start-date").value = "";
            document.getElementById("end-date").value = "";
            return false;
          }
        }
        return true;
      }

      function showNotification(message, type = "success") {
        const notification = document.createElement("div");
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document
          .getElementById("notifications-container")
          .appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
      }

      function logout() {
        fetch("/api/auth/logout", {
          method: "POST",
          credentials: "include",
        }).then(() => {
          window.location.href = "/";
        });
      }
    </script>
  </body>
</html>
