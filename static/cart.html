<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ö–æ—Ä–∑–∏–Ω–∞</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
  </head>
  <body data-page="cart">
    <header>
      <nav>
        <a href="/">–ì–ª–∞–≤–Ω–∞—è</a>
        <a href="/price.html">–ü—Ä–∞–π—Å</a>
        <div id="auth-links" hx-get="/api/auth/me" hx-trigger="load">
          <!-- Auth links will be loaded here -->
        </div>
        <a href="/cart.html">–ö–æ—Ä–∑–∏–Ω–∞</a>
      </nav>
    </header>
    <main>
      <div id="cart">
        <h2>üõí –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</h2>
        <div
          id="cart-items"
          hx-get="/api/cart/items"
          hx-trigger="load, cart-updated from:body"
          hx-swap="innerHTML"
        ></div>
      </div>

      <div class="date-picker">
        <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫–∏ –∞—Ä–µ–Ω–¥—ã</h3>
        <label>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –∞—Ä–µ–Ω–¥—ã:</label>
        <input type="date" id="rental-start" name="rental_start" />

        <label>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞—Ä–µ–Ω–¥—ã:</label>
        <input type="date" id="rental-end" name="rental_end" />

        <button
          hx-post="/api/cart/save-dates"
          hx-include="[name='rental_start'], [name='rental_end']"
          hx-swap="none"
          hx-trigger="click"
        >
          –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞—Ç—ã
        </button>
      </div>

      <div id="cart-buttons">
        <button
          id="clear-cart-button"
          hx-post="/api/cart/clear"
          hx-swap="none"
          hx-trigger="click"
          hx-on::after-request="
            document.body.dispatchEvent(new Event('cart-updated'));
            document.getElementById('rental-start').value = '';
            document.getElementById('rental-end').value = '';
          "
        >
          –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É
        </button>
        <button
          id="checkout-button"
          hx-post="/api/cart/checkout"
          hx-swap="none"
          hx-trigger="click"
          hx-on::before-request="
            const cartItems = document.querySelectorAll('.cart-item');
            if (cartItems.length === 0) {
              showNotification('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞', 'error');
              event.preventDefault();
              return false;
            }
            const startDate = document.getElementById('rental-start').value;
            const endDate = document.getElementById('rental-end').value;
            if (!startDate || !endDate) {
              showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—ã –∞—Ä–µ–Ω–¥—ã', 'error');
              event.preventDefault();
              return false;
            }
          "
          hx-on::after-request="
            if (event.detail.successful) {
              showNotification('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω', 'success');
              document.getElementById('rental-start').value = '';
              document.getElementById('rental-end').value = '';
              window.location.reload();
            }
          "
        >
          –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
        </button>
      </div>
    </main>

    <div id="notifications-container"></div>

    <script>
      let notificationShown = false;

      function showNotification(message, type) {
        if (notificationShown) return;
        notificationShown = true;

        const notification = document.createElement("div");
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document
          .getElementById("notifications-container")
          .appendChild(notification);
        setTimeout(() => {
          notification.remove();
          notificationShown = false;
        }, 3000);
      }

      // Handle authentication errors
      document.body.addEventListener("htmx:afterRequest", function (evt) {
        if (evt.detail.pathInfo.requestPath === "/api/cart/items") {
          if (evt.detail.xhr.status === 401) {
            const response = JSON.parse(evt.detail.xhr.response);
            if (response.redirect) {
              window.location.href = response.redirect;
            }
          }
        }
      });
    </script>
  </body>
</html>
