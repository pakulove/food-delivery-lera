<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ö–æ—Ä–∑–∏–Ω–∞</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <script src="script.js"></script>
  </head>
  <body data-page="cart">
    <header>
      <nav>
        <a href="/">–ì–ª–∞–≤–Ω–∞—è</a>
        <a href="/price.html">–ü—Ä–∞–π—Å</a>
        <div id="auth-links" hx-get="/api/auth/me" hx-trigger="load"></div>
        <a href="/cart.html">–ö–æ—Ä–∑–∏–Ω–∞</a>
      </nav>
    </header>
    <main>
      <div id="cart-container">
        <div id="cart">
          <h2>üõí –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</h2>
          <div
            id="cart-items"
            hx-get="/api/cart/items"
            hx-trigger="load, cart-updated from:body"
            hx-swap="innerHTML"
          ></div>
        </div>

        <div class="order-details">
          <div class="date-picker">
            <h2>üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—ã –∞—Ä–µ–Ω–¥—ã</h2>
            <label for="start-date">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</label>
            <input type="date" id="start-date" name="start-date" required />

            <label for="end-date">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label>
            <input type="date" id="end-date" name="end-date" required />
          </div>

          <div class="payment-method">
            <h3>üí≥ –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</h3>
            <div class="payment-options">
              <label class="payment-option">
                <input
                  type="radio"
                  name="payment"
                  value="card"
                  checked
                  onchange="toggleCardFields(true)"
                />
                <span>üí≥ –ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</span>
              </label>
              <label class="payment-option">
                <input
                  type="radio"
                  name="payment"
                  value="cash"
                  onchange="toggleCardFields(false)"
                />
                <span>üíµ –ù–∞–ª–∏—á–Ω—ã–µ</span>
              </label>
            </div>

            <div id="card-fields" class="card-fields">
              <div class="form-group">
                <label for="card-number">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã:</label>
                <input
                  type="text"
                  id="card-number"
                  name="card-number"
                  placeholder="XXXX XXXX XXXX XXXX"
                  maxlength="19"
                  oninput="formatCardNumber(this)"
                  required
                />
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="card-expiry">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è:</label>
                  <input
                    type="text"
                    id="card-expiry"
                    name="card-expiry"
                    placeholder="MM/YY"
                    maxlength="5"
                    oninput="formatExpiry(this)"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="card-cvv">CVV:</label>
                  <input
                    type="text"
                    id="card-cvv"
                    name="card-cvv"
                    placeholder="XXX"
                    maxlength="3"
                    oninput="formatCVV(this)"
                    required
                  />
                </div>
              </div>
              <div class="form-group">
                <label for="card-holder">–ò–º—è –≤–ª–∞–¥–µ–ª—å—Ü–∞:</label>
                <input
                  type="text"
                  id="card-holder"
                  name="card-holder"
                  placeholder="IVAN IVANOV"
                  oninput="formatCardHolder(this)"
                  required
                />
              </div>
            </div>
          </div>

          <div class="cart-buttons">
            <button
              id="clear-cart-button"
              hx-post="/api/cart/clear"
              hx-swap="none"
              hx-trigger="click"
              hx-on::after-request="
                document.body.dispatchEvent(new Event('cart-updated'));
                document.getElementById('start-date').value = '';
                document.getElementById('end-date').value = '';
              "
            >
              –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É
            </button>

            <button
              id="checkout-button"
              hx-post="/api/cart/checkout"
              hx-include="[name='start-date'], [name='end-date'], [name='payment'], [name='card-number'], [name='card-expiry'], [name='card-cvv'], [name='card-holder']"
              hx-swap="none"
              hx-on::before-request="
                const cartItems = document.querySelectorAll('.cart-item');
                if (cartItems.length === 0) {
                  showNotification('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞', 'error');
                  event.preventDefault();
                  return false;
                }
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                if (!startDate || !endDate) {
                  showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—ã –∞—Ä–µ–Ω–¥—ã', 'error');
                  event.preventDefault();
                  return false;
                }
                if (new Date(startDate) > new Date(endDate)) {
                  showNotification('–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–∑–∂–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è', 'error');
                  event.preventDefault();
                  return false;
                }
                const paymentMethod = document.querySelector('input[name=payment]:checked').value;
                if (paymentMethod === 'card') {
                  const cardNumber = document.getElementById('card-number').value;
                  const cardExpiry = document.getElementById('card-expiry').value;
                  const cardCVV = document.getElementById('card-cvv').value;
                  const cardHolder = document.getElementById('card-holder').value;
                  if (!cardNumber || !cardExpiry || !cardCVV || !cardHolder) {
                    showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–∞—Ä—Ç—ã', 'error');
                    event.preventDefault();
                    return false;
                  }
                }
              "
              hx-on::after-request="
                if (event.detail.successful) {
                  showNotification('‚úÖ –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω!', 'success');
                  setTimeout(() => {
                    window.location.href = '/profile.html';
                  }, 2000);
                } else if (event.detail.xhr.status === 401) {
                  window.location.href = '/login.html';
                } else {
                  showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞', 'error');
                }
              "
            >
              –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
            </button>
          </div>
        </div>
      </div>
    </main>

    <div id="notifications-container"></div>

    <script>
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      document.addEventListener("DOMContentLoaded", function () {
        fetch("/api/auth/me")
          .then((response) => response.text())
          .then((html) => {
            if (html.includes("–í–æ–π—Ç–∏")) {
              window.location.href = "/login.html";
            }
          });
      });

      function validateDates() {
        const startDate = document.getElementById("start-date").value;
        const endDate = document.getElementById("end-date").value;

        if (startDate && endDate) {
          if (new Date(startDate) > new Date(endDate)) {
            alert("–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–∑–∂–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è");
            document.getElementById("start-date").value = "";
            document.getElementById("end-date").value = "";
            return false;
          }
        }
        return true;
      }

      function showNotification(message, type = "success") {
        const notification = document.createElement("div");
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document
          .getElementById("notifications-container")
          .appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
      }

      function logout() {
        fetch("/api/auth/logout", {
          method: "POST",
          credentials: "include",
        }).then(() => {
          window.location.href = "/";
        });
      }

      function toggleCardFields(show) {
        const cardFields = document.getElementById("card-fields");
        cardFields.style.display = show ? "block" : "none";
        const inputs = cardFields.querySelectorAll("input");
        inputs.forEach((input) => {
          input.required = show;
        });
      }

      function formatCardNumber(input) {
        let value = input.value.replace(/\D/g, "");
        value = value.replace(/(\d{4})/g, "$1 ").trim();
        input.value = value;
      }

      function formatExpiry(input) {
        let value = input.value.replace(/\D/g, "");
        if (value.length >= 2) {
          value = value.slice(0, 2) + "/" + value.slice(2);
        }
        input.value = value;
      }

      function formatCVV(input) {
        input.value = input.value.replace(/\D/g, "").slice(0, 3);
      }

      function formatCardHolder(input) {
        input.value = input.value.toUpperCase();
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–µ–π –∫–∞—Ä—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      document.addEventListener("DOMContentLoaded", function () {
        const paymentMethod = document.querySelector(
          "input[name=payment]:checked"
        ).value;
        toggleCardFields(paymentMethod === "card");
      });
    </script>
  </body>
</html>
